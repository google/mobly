<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>mobly.controllers.android_device &mdash; Mobly  documentation</title>
    
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../_static/doctools.js"></script>
    <link rel="top" title="Mobly  documentation" href="../../../index.html" />
    <link rel="up" title="Module code" href="../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for mobly.controllers.android_device</h1><div class="highlight"><pre>
<span class="c1"># Copyright 2016 Google Inc.</span>
<span class="c1">#</span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1">#</span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1">#</span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">str</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">open</span>
<span class="kn">from</span> <span class="nn">past.builtins</span> <span class="kn">import</span> <span class="nb">basestring</span>

<span class="kn">import</span> <span class="nn">contextlib</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="kn">from</span> <span class="nn">mobly</span> <span class="kn">import</span> <span class="n">logger</span> <span class="k">as</span> <span class="n">mobly_logger</span>
<span class="kn">from</span> <span class="nn">mobly</span> <span class="kn">import</span> <span class="n">signals</span>
<span class="kn">from</span> <span class="nn">mobly</span> <span class="kn">import</span> <span class="n">utils</span>
<span class="kn">from</span> <span class="nn">mobly.controllers.android_device_lib</span> <span class="kn">import</span> <span class="n">adb</span>
<span class="kn">from</span> <span class="nn">mobly.controllers.android_device_lib</span> <span class="kn">import</span> <span class="n">fastboot</span>
<span class="kn">from</span> <span class="nn">mobly.controllers.android_device_lib</span> <span class="kn">import</span> <span class="n">sl4a_client</span>
<span class="kn">from</span> <span class="nn">mobly.controllers.android_device_lib</span> <span class="kn">import</span> <span class="n">snippet_client</span>

<span class="c1"># Convenience constant for the package of Mobly Bundled Snippets</span>
<span class="c1"># (http://github.com/google/mobly-bundled-snippets).</span>
<span class="n">MBS_PACKAGE</span> <span class="o">=</span> <span class="s1">&#39;com.google.android.mobly.snippet.bundled&#39;</span>

<span class="n">MOBLY_CONTROLLER_CONFIG_NAME</span> <span class="o">=</span> <span class="s1">&#39;AndroidDevice&#39;</span>

<span class="n">ANDROID_DEVICE_PICK_ALL_TOKEN</span> <span class="o">=</span> <span class="s1">&#39;*&#39;</span>
<span class="n">_DEBUG_PREFIX_TEMPLATE</span> <span class="o">=</span> <span class="s1">&#39;[AndroidDevice|</span><span class="si">%s</span><span class="s1">] </span><span class="si">%s</span><span class="s1">&#39;</span>

<span class="c1"># Key name for adb logcat extra params in config file.</span>
<span class="n">ANDROID_DEVICE_ADB_LOGCAT_PARAM_KEY</span> <span class="o">=</span> <span class="s1">&#39;adb_logcat_param&#39;</span>
<span class="n">ANDROID_DEVICE_EMPTY_CONFIG_MSG</span> <span class="o">=</span> <span class="s1">&#39;Configuration is empty, abort!&#39;</span>
<span class="n">ANDROID_DEVICE_NOT_LIST_CONFIG_MSG</span> <span class="o">=</span> <span class="s1">&#39;Configuration should be a list, abort!&#39;</span>

<span class="c1"># Keys for attributes in configs that alternate the controller module behavior.</span>
<span class="n">KEY_DEVICE_REQUIRED</span> <span class="o">=</span> <span class="s1">&#39;required&#39;</span>

<span class="c1"># Default Timeout to wait for boot completion</span>
<span class="n">DEFAULT_TIMEOUT_BOOT_COMPLETION_SECOND</span> <span class="o">=</span> <span class="mi">15</span> <span class="o">*</span> <span class="mi">60</span>


<div class="viewcode-block" id="Error"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.Error">[docs]</a><span class="k">class</span> <span class="nc">Error</span><span class="p">(</span><span class="n">signals</span><span class="o">.</span><span class="n">ControllerError</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="DeviceError"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.DeviceError">[docs]</a><span class="k">class</span> <span class="nc">DeviceError</span><span class="p">(</span><span class="n">Error</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised for errors from within an AndroidDevice object.&quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ad</span><span class="p">,</span> <span class="n">msg</span><span class="p">):</span>
        <span class="n">new_msg</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">repr</span><span class="p">(</span><span class="n">ad</span><span class="p">),</span> <span class="n">msg</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">DeviceError</span><span class="p">,</span> <span class="bp">self</span><span class="p">)</span><span class="o">.</span><span class="n">__init__</span><span class="p">(</span><span class="n">new_msg</span><span class="p">)</span></div>


<div class="viewcode-block" id="SnippetError"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.SnippetError">[docs]</a><span class="k">class</span> <span class="nc">SnippetError</span><span class="p">(</span><span class="n">DeviceError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raised for errors related to Mobly snippet.&quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="create"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.create">[docs]</a><span class="k">def</span> <span class="nf">create</span><span class="p">(</span><span class="n">configs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates AndroidDevice controller objects.</span>

<span class="sd">    Args:</span>
<span class="sd">        configs: A list of dicts, each representing a configuration for an</span>
<span class="sd">            Android device.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of AndroidDevice objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">configs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="n">ANDROID_DEVICE_EMPTY_CONFIG_MSG</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">configs</span> <span class="o">==</span> <span class="n">ANDROID_DEVICE_PICK_ALL_TOKEN</span><span class="p">:</span>
        <span class="n">ads</span> <span class="o">=</span> <span class="n">get_all_instances</span><span class="p">()</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">configs</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="n">ANDROID_DEVICE_NOT_LIST_CONFIG_MSG</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="c1"># Configs is a list of dicts.</span>
        <span class="n">ads</span> <span class="o">=</span> <span class="n">get_instances_with_configs</span><span class="p">(</span><span class="n">configs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">configs</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="nb">basestring</span><span class="p">):</span>
        <span class="c1"># Configs is a list of strings representing serials.</span>
        <span class="n">ads</span> <span class="o">=</span> <span class="n">get_instances</span><span class="p">(</span><span class="n">configs</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s2">&quot;No valid config found in: </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">configs</span><span class="p">)</span>
    <span class="n">valid_ad_identifiers</span> <span class="o">=</span> <span class="n">list_adb_devices</span><span class="p">()</span> <span class="o">+</span> <span class="n">list_adb_devices_by_usb_id</span><span class="p">()</span>

    <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">ads</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">ad</span><span class="o">.</span><span class="n">serial</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_ad_identifiers</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DeviceError</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="s1">&#39;Android device is specified in config but&#39;</span>
                              <span class="s1">&#39; is not attached.&#39;</span><span class="p">)</span>
    <span class="n">_start_services_on_ads</span><span class="p">(</span><span class="n">ads</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">ads</span></div>


<div class="viewcode-block" id="destroy"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.destroy">[docs]</a><span class="k">def</span> <span class="nf">destroy</span><span class="p">(</span><span class="n">ads</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cleans up AndroidDevice objects.</span>

<span class="sd">    Args:</span>
<span class="sd">        ads: A list of AndroidDevice objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">ads</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ad</span><span class="o">.</span><span class="n">stop_services</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ad</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Failed to clean up properly.&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_info"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.get_info">[docs]</a><span class="k">def</span> <span class="nf">get_info</span><span class="p">(</span><span class="n">ads</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Get information on a list of AndroidDevice objects.</span>

<span class="sd">    Args:</span>
<span class="sd">        ads: A list of AndroidDevice objects.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of dict, each representing info for an AndroidDevice objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">device_info</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">ads</span><span class="p">:</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;serial&#39;</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">serial</span><span class="p">,</span> <span class="s1">&#39;model&#39;</span><span class="p">:</span> <span class="n">ad</span><span class="o">.</span><span class="n">model</span><span class="p">}</span>
        <span class="n">info</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">ad</span><span class="o">.</span><span class="n">build_info</span><span class="p">)</span>
        <span class="n">device_info</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">info</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">device_info</span></div>


<span class="k">def</span> <span class="nf">_start_services_on_ads</span><span class="p">(</span><span class="n">ads</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Starts long running services on multiple AndroidDevice objects.</span>

<span class="sd">    If any one AndroidDevice object fails to start services, cleans up all</span>
<span class="sd">    existing AndroidDevice objects and their services.</span>

<span class="sd">    Args:</span>
<span class="sd">        ads: A list of AndroidDevice objects whose services to start.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">running_ads</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">ads</span><span class="p">:</span>
        <span class="n">running_ads</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ad</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ad</span><span class="o">.</span><span class="n">start_services</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">is_required</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">KEY_DEVICE_REQUIRED</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">is_required</span><span class="p">:</span>
                <span class="n">ad</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Failed to start some services, abort!&#39;</span><span class="p">)</span>
                <span class="n">destroy</span><span class="p">(</span><span class="n">running_ads</span><span class="p">)</span>
                <span class="k">raise</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ad</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Skipping this optional device because some &#39;</span>
                                 <span class="s1">&#39;services failed to start.&#39;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_parse_device_list</span><span class="p">(</span><span class="n">device_list_str</span><span class="p">,</span> <span class="n">key</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Parses a byte string representing a list of devices.</span>

<span class="sd">    The string is generated by calling either adb or fastboot. The tokens in</span>
<span class="sd">    each string is tab-separated.</span>

<span class="sd">    Args:</span>
<span class="sd">        device_list_str: Output of adb or fastboot.</span>
<span class="sd">        key: The token that signifies a device in device_list_str.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of android device serial numbers.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">clean_lines</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">device_list_str</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">clean_lines</span><span class="p">:</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\t</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">key</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">results</span>


<div class="viewcode-block" id="list_adb_devices"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.list_adb_devices">[docs]</a><span class="k">def</span> <span class="nf">list_adb_devices</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;List all android devices connected to the computer that are detected by</span>
<span class="sd">    adb.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of android device serials. Empty if there&#39;s none.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">adb</span><span class="o">.</span><span class="n">AdbProxy</span><span class="p">()</span><span class="o">.</span><span class="n">devices</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_parse_device_list</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;device&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="list_adb_devices_by_usb_id"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.list_adb_devices_by_usb_id">[docs]</a><span class="k">def</span> <span class="nf">list_adb_devices_by_usb_id</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;List the usb id of all android devices connected to the computer that</span>
<span class="sd">    are detected by adb.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of strings that are android device usb ids. Empty if there&#39;s</span>
<span class="sd">        none.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">adb</span><span class="o">.</span><span class="n">AdbProxy</span><span class="p">()</span><span class="o">.</span><span class="n">devices</span><span class="p">([</span><span class="s1">&#39;-l&#39;</span><span class="p">])</span>
    <span class="n">clean_lines</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">clean_lines</span><span class="p">:</span>
        <span class="n">tokens</span> <span class="o">=</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="ow">and</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;device&#39;</span><span class="p">:</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tokens</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="list_fastboot_devices"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.list_fastboot_devices">[docs]</a><span class="k">def</span> <span class="nf">list_fastboot_devices</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;List all android devices connected to the computer that are in in</span>
<span class="sd">    fastboot mode. These are detected by fastboot.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of android device serials. Empty if there&#39;s none.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">fastboot</span><span class="o">.</span><span class="n">FastbootProxy</span><span class="p">()</span><span class="o">.</span><span class="n">devices</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">_parse_device_list</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;fastboot&#39;</span><span class="p">)</span></div>


<div class="viewcode-block" id="get_instances"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.get_instances">[docs]</a><span class="k">def</span> <span class="nf">get_instances</span><span class="p">(</span><span class="n">serials</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create AndroidDevice instances from a list of serials.</span>

<span class="sd">    Args:</span>
<span class="sd">        serials: A list of android device serials.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of AndroidDevice objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">serials</span><span class="p">:</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">AndroidDevice</span><span class="p">(</span><span class="n">s</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="get_instances_with_configs"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.get_instances_with_configs">[docs]</a><span class="k">def</span> <span class="nf">get_instances_with_configs</span><span class="p">(</span><span class="n">configs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create AndroidDevice instances from a list of dict configs.</span>

<span class="sd">    Each config should have the required key-value pair &#39;serial&#39;.</span>

<span class="sd">    Args:</span>
<span class="sd">        configs: A list of dicts each representing the configuration of one</span>
<span class="sd">            android device.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of AndroidDevice objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">configs</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">serial</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;serial&#39;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span>
                <span class="s1">&#39;Required value &quot;serial&quot; is missing in AndroidDevice config </span><span class="si">%s</span><span class="s1">.&#39;</span>
                <span class="o">%</span> <span class="n">c</span><span class="p">)</span>
        <span class="n">is_required</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">KEY_DEVICE_REQUIRED</span><span class="p">,</span> <span class="bp">True</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ad</span> <span class="o">=</span> <span class="n">AndroidDevice</span><span class="p">(</span><span class="n">serial</span><span class="p">)</span>
            <span class="n">ad</span><span class="o">.</span><span class="n">load_config</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">is_required</span><span class="p">:</span>
                <span class="k">raise</span>
            <span class="n">ad</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Skipping this optional device due to error.&#39;</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ad</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="get_all_instances"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.get_all_instances">[docs]</a><span class="k">def</span> <span class="nf">get_all_instances</span><span class="p">(</span><span class="n">include_fastboot</span><span class="o">=</span><span class="bp">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create AndroidDevice instances for all attached android devices.</span>

<span class="sd">    Args:</span>
<span class="sd">        include_fastboot: Whether to include devices in bootloader mode or not.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of AndroidDevice objects each representing an android device</span>
<span class="sd">        attached to the computer.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">include_fastboot</span><span class="p">:</span>
        <span class="n">serial_list</span> <span class="o">=</span> <span class="n">list_adb_devices</span><span class="p">()</span> <span class="o">+</span> <span class="n">list_fastboot_devices</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">get_instances</span><span class="p">(</span><span class="n">serial_list</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">get_instances</span><span class="p">(</span><span class="n">list_adb_devices</span><span class="p">())</span></div>


<div class="viewcode-block" id="filter_devices"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.filter_devices">[docs]</a><span class="k">def</span> <span class="nf">filter_devices</span><span class="p">(</span><span class="n">ads</span><span class="p">,</span> <span class="n">func</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds the AndroidDevice instances from a list that match certain</span>
<span class="sd">    conditions.</span>

<span class="sd">    Args:</span>
<span class="sd">        ads: A list of AndroidDevice instances.</span>
<span class="sd">        func: A function that takes an AndroidDevice object and returns True</span>
<span class="sd">            if the device satisfies the filter condition.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of AndroidDevice instances that satisfy the filter condition.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">ads</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">func</span><span class="p">(</span><span class="n">ad</span><span class="p">):</span>
            <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">ad</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="get_device"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.get_device">[docs]</a><span class="k">def</span> <span class="nf">get_device</span><span class="p">(</span><span class="n">ads</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Finds a unique AndroidDevice instance from a list that has specific</span>
<span class="sd">    attributes of certain values.</span>

<span class="sd">    Example:</span>
<span class="sd">        get_device(android_devices, label=&#39;foo&#39;, phone_number=&#39;1234567890&#39;)</span>
<span class="sd">        get_device(android_devices, model=&#39;angler&#39;)</span>

<span class="sd">    Args:</span>
<span class="sd">        ads: A list of AndroidDevice instances.</span>
<span class="sd">        kwargs: keyword arguments used to filter AndroidDevice instances.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The target AndroidDevice instance.</span>

<span class="sd">    Raises:</span>
<span class="sd">        Error: None or more than one device is</span>
<span class="sd">            matched.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">_get_device_filter</span><span class="p">(</span><span class="n">ad</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                <span class="k">return</span> <span class="bp">False</span>
            <span class="k">elif</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">ad</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="o">!=</span> <span class="n">v</span><span class="p">:</span>
                <span class="k">return</span> <span class="bp">False</span>
        <span class="k">return</span> <span class="bp">True</span>

    <span class="n">filtered</span> <span class="o">=</span> <span class="n">filter_devices</span><span class="p">(</span><span class="n">ads</span><span class="p">,</span> <span class="n">_get_device_filter</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filtered</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span>
            <span class="s1">&#39;Could not find a target device that matches condition: </span><span class="si">%s</span><span class="s1">.&#39;</span> <span class="o">%</span>
            <span class="n">kwargs</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">filtered</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">serials</span> <span class="o">=</span> <span class="p">[</span><span class="n">ad</span><span class="o">.</span><span class="n">serial</span> <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">filtered</span><span class="p">]</span>
        <span class="k">raise</span> <span class="n">Error</span><span class="p">(</span><span class="s1">&#39;More than one device matched: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">serials</span><span class="p">)</span></div>


<div class="viewcode-block" id="take_bug_reports"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.take_bug_reports">[docs]</a><span class="k">def</span> <span class="nf">take_bug_reports</span><span class="p">(</span><span class="n">ads</span><span class="p">,</span> <span class="n">test_name</span><span class="p">,</span> <span class="n">begin_time</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Takes bug reports on a list of android devices.</span>

<span class="sd">    If you want to take a bug report, call this function with a list of</span>
<span class="sd">    android_device objects in on_fail. But reports will be taken on all the</span>
<span class="sd">    devices in the list concurrently. Bug report takes a relative long</span>
<span class="sd">    time to take, so use this cautiously.</span>

<span class="sd">    Args:</span>
<span class="sd">        ads: A list of AndroidDevice instances.</span>
<span class="sd">        test_name: Name of the test method that triggered this bug report.</span>
<span class="sd">        begin_time: timestamp taken when the test started, can be either</span>
<span class="sd">            string or int.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">begin_time</span> <span class="o">=</span> <span class="n">mobly_logger</span><span class="o">.</span><span class="n">normalize_log_line_timestamp</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">begin_time</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">take_br</span><span class="p">(</span><span class="n">test_name</span><span class="p">,</span> <span class="n">begin_time</span><span class="p">,</span> <span class="n">ad</span><span class="p">):</span>
        <span class="n">ad</span><span class="o">.</span><span class="n">take_bug_report</span><span class="p">(</span><span class="n">test_name</span><span class="p">,</span> <span class="n">begin_time</span><span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="p">[(</span><span class="n">test_name</span><span class="p">,</span> <span class="n">begin_time</span><span class="p">,</span> <span class="n">ad</span><span class="p">)</span> <span class="k">for</span> <span class="n">ad</span> <span class="ow">in</span> <span class="n">ads</span><span class="p">]</span>
    <span class="n">utils</span><span class="o">.</span><span class="n">concurrent_exec</span><span class="p">(</span><span class="n">take_br</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span></div>


<div class="viewcode-block" id="AndroidDevice"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice">[docs]</a><span class="k">class</span> <span class="nc">AndroidDevice</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class representing an android device.</span>

<span class="sd">    Each object of this class represents one Android device in Mobly. This class</span>
<span class="sd">    provides various ways, like adb, fastboot, sl4a, and snippets, to control an</span>
<span class="sd">    Android device, whether it&#39;s a real device or an emulator instance.</span>

<span class="sd">    Attributes:</span>
<span class="sd">        serial: A string that&#39;s the serial number of the Androi device.</span>
<span class="sd">        log_path: A string that is the path where all logs collected on this</span>
<span class="sd">            android device should be stored.</span>
<span class="sd">        log: A logger adapted from root logger with an added prefix specific</span>
<span class="sd">            to an AndroidDevice instance. The default prefix is</span>
<span class="sd">            [AndroidDevice|&lt;serial&gt;]. Use self.debug_tag = &#39;tag&#39; to use a</span>
<span class="sd">            different tag in the prefix.</span>
<span class="sd">        adb_logcat_file_path: A string that&#39;s the full path to the adb logcat</span>
<span class="sd">            file collected, if any.</span>
<span class="sd">        adb: An AdbProxy object used for interacting with the device via adb.</span>
<span class="sd">        fastboot: A FastbootProxy object used for interacting with the device</span>
<span class="sd">            via fastboot.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">serial</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">serial</span> <span class="o">=</span> <span class="n">serial</span>
        <span class="c1"># logging.log_path only exists when this is used in an Mobly test run.</span>
        <span class="n">log_path_base</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">logging</span><span class="p">,</span> <span class="s1">&#39;log_path&#39;</span><span class="p">,</span> <span class="s1">&#39;/tmp/logs&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">log_path_base</span><span class="p">,</span> <span class="s1">&#39;AndroidDevice</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">serial</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug_tag</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span> <span class="o">=</span> <span class="n">AndroidDeviceLoggerAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(),</span>
                                              <span class="p">{</span><span class="s1">&#39;tag&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_tag</span><span class="p">})</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sl4a</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ed</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_adb_logcat_process</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adb_logcat_file_path</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adb</span> <span class="o">=</span> <span class="n">adb</span><span class="o">.</span><span class="n">AdbProxy</span><span class="p">(</span><span class="n">serial</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fastboot</span> <span class="o">=</span> <span class="n">fastboot</span><span class="o">.</span><span class="n">FastbootProxy</span><span class="p">(</span><span class="n">serial</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_bootloader</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_rootable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_adb</span><span class="p">()</span>
        <span class="c1"># A dict for tracking snippet clients. Keys are clients&#39; attribute</span>
        <span class="c1"># names, values are the clients: {&lt;attr name string&gt;: &lt;client object&gt;}.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_snippet_clients</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;AndroidDevice|</span><span class="si">%s</span><span class="s2">&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug_tag</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">debug_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A string that represents a device object in debug info. Default value</span>
<span class="sd">        is the device serial.</span>

<span class="sd">        This will be used as part of the prefix of debugging messages emitted by</span>
<span class="sd">        this device object, like log lines and the message of DeviceError.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug_tag</span>

    <span class="nd">@debug_tag.setter</span>
    <span class="k">def</span> <span class="nf">debug_tag</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Setter for the debug tag.</span>

<span class="sd">        By default, the tag is the serial of the device, but sometimes it may</span>
<span class="sd">        be more descriptive to use a different tag of the user&#39;s choice.</span>

<span class="sd">        Changing debug tag changes part of the prefix of debug info emitted by</span>
<span class="sd">        this object, like log lines and the message of DeviceError.</span>

<span class="sd">        Example:</span>
<span class="sd">            By default, the device&#39;s serial number is used:</span>
<span class="sd">                &#39;INFO [AndroidDevice|abcdefg12345] One pending call ringing.&#39;</span>
<span class="sd">            The tag can be customized with `ad.debug_tag = &#39;Caller&#39;`:</span>
<span class="sd">                &#39;INFO [AndroidDevice|Caller] One pending call ringing.&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Logging debug tag set to &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span><span class="p">,</span> <span class="n">tag</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug_tag</span> <span class="o">=</span> <span class="n">tag</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">extra</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">tag</span>

<div class="viewcode-block" id="AndroidDevice.start_services"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.start_services">[docs]</a>    <span class="k">def</span> <span class="nf">start_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clear_log</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts long running services on the android device, like adb logcat</span>
<span class="sd">        capture.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">start_adb_logcat</span><span class="p">(</span><span class="n">clear_log</span><span class="p">)</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Failed to start adb logcat!&#39;</span><span class="p">)</span>
            <span class="k">raise</span></div>

<div class="viewcode-block" id="AndroidDevice.stop_services"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.stop_services">[docs]</a>    <span class="k">def</span> <span class="nf">stop_services</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stops long running services on the Android device.</span>

<span class="sd">        Stop adb logcat, terminate sl4a sessions if exist, terminate all</span>
<span class="sd">        snippet clients.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dict containing information on the running services before they</span>
<span class="sd">            are torn down. This can be used to restore these services, which</span>
<span class="sd">            includes snippets and sl4a.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">service_info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">service_info</span><span class="p">[</span><span class="s1">&#39;snippet_info&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_active_snippet_info</span><span class="p">()</span>
        <span class="n">service_info</span><span class="p">[</span><span class="s1">&#39;use_sl4a&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sl4a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_terminate_sl4a</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">client</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snippet_clients</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">client</span><span class="o">.</span><span class="n">stop_app</span><span class="p">()</span>
            <span class="nb">delattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">attr_name</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_snippet_clients</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_logcat_process</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">service_info</span></div>

    <span class="k">def</span> <span class="nf">_stop_logcat_process</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stops logcat process.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adb_logcat_process</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">stop_adb_logcat</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Failed to stop adb logcat.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_adb_logcat_process</span> <span class="o">=</span> <span class="bp">None</span>

    <span class="nd">@contextlib.contextmanager</span>
<div class="viewcode-block" id="AndroidDevice.handle_reboot"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.handle_reboot">[docs]</a>    <span class="k">def</span> <span class="nf">handle_reboot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Properly manage the service life cycle when the device needs to</span>
<span class="sd">        temporarily disconnect.</span>

<span class="sd">        The device can temporarily lose adb connection due to user-triggered</span>
<span class="sd">        reboot. Use this function to make sure the services</span>
<span class="sd">        started by Mobly are properly stopped and restored afterwards.</span>

<span class="sd">        For sample usage, see self.reboot().</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">service_info</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">stop_services</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_restore_services</span><span class="p">(</span><span class="n">service_info</span><span class="p">)</span></div>

    <span class="nd">@contextlib.contextmanager</span>
<div class="viewcode-block" id="AndroidDevice.handle_usb_disconnect"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.handle_usb_disconnect">[docs]</a>    <span class="k">def</span> <span class="nf">handle_usb_disconnect</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Properly manage the service life cycle when USB is disconnected.</span>

<span class="sd">        The device can temporarily lose adb connection due to user-triggered</span>
<span class="sd">        USB disconnection, e.g. the following cases can be handled by this</span>
<span class="sd">        method:</span>

<span class="sd">        * Power measurement: Using Monsoon device to measure battery consumption</span>
<span class="sd">            would potentially disconnect USB.</span>
<span class="sd">        * Unplug USB so device loses connection.</span>
<span class="sd">        * ADB connection over WiFi and WiFi got disconnected.</span>
<span class="sd">        * Any other type of USB disconnection, as long as snippet session can be</span>
<span class="sd">            kept alive while USB disconnected (reboot caused USB disconnection is</span>
<span class="sd">            not one of these cases because snippet session cannot survive reboot.</span>
<span class="sd">            Use handle_reboot() instead).</span>

<span class="sd">        Use this function to make sure the services started by Mobly are</span>
<span class="sd">        properly reconnected afterwards.</span>

<span class="sd">        Just like the usage of self.handle_reboot(), this method does not</span>
<span class="sd">        automatically detect if the disconnection is because of a reboot or USB</span>
<span class="sd">        disconnect. Users of this function should make sure the right handle_*</span>
<span class="sd">        function is used to handle the correct type of disconnection.</span>

<span class="sd">        This method also reconnects snippet event client. Therefore, the</span>
<span class="sd">        callback objects created (by calling Async RPC methods) before</span>
<span class="sd">        disconnection would still be valid and can be used to retrieve RPC</span>
<span class="sd">        execution result after device got reconnected.</span>

<span class="sd">        Example Usage:</span>
<span class="sd">            with ad.handle_usb_disconnect():</span>
<span class="sd">                try:</span>
<span class="sd">                  # User action that triggers USB disconnect, could throw</span>
<span class="sd">                  # exceptions.</span>
<span class="sd">                  do_something()</span>
<span class="sd">                finally:</span>
<span class="sd">                  # User action that triggers USB reconnect</span>
<span class="sd">                  action_that_reconnects_usb()</span>
<span class="sd">                  # Make sure device is reconnected before returning from this</span>
<span class="sd">                  # context</span>
<span class="sd">                  ad.adb.wait_for_device(timeout=SOME_TIMEOUT)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stop_logcat_process</span><span class="p">()</span>
        <span class="c1"># Only need to stop dispatcher because it continuously polling device</span>
        <span class="c1"># It&#39;s not necessary to stop snippet and sl4a.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sl4a</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sl4a</span><span class="o">.</span><span class="n">stop_event_dispatcher</span><span class="p">()</span>
        <span class="c1"># Clears cached adb content, so that the next time start_adb_logcat()</span>
        <span class="c1"># won&#39;t produce duplicated logs to log file.</span>
        <span class="c1"># This helps disconnection that caused by, e.g., USB off; at the</span>
        <span class="c1"># cost of losing logs at disconnection caused by reboot.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_clear_adb_log</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_reconnect_to_services</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">_restore_services</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">service_info</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Restores services after a device has come back from temporary</span>
<span class="sd">        being offline.</span>

<span class="sd">        Args:</span>
<span class="sd">            service_info: A dict containing information on the services to</span>
<span class="sd">                          restore, which could include snippet and sl4a.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_boot_completion</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_rootable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">root_adb</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_services</span><span class="p">()</span>
        <span class="c1"># Restore snippets.</span>
        <span class="n">snippet_info</span> <span class="o">=</span> <span class="n">service_info</span><span class="p">[</span><span class="s1">&#39;snippet_info&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">package_name</span> <span class="ow">in</span> <span class="n">snippet_info</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_snippet</span><span class="p">(</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">package_name</span><span class="p">)</span>
        <span class="c1"># Restore sl4a if needed.</span>
        <span class="k">if</span> <span class="n">service_info</span><span class="p">[</span><span class="s1">&#39;use_sl4a&#39;</span><span class="p">]:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">load_sl4a</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_reconnect_to_services</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reconnects to services after USB reconnected.&quot;&quot;&quot;</span>
        <span class="c1"># Do not clear device log at this time. Otherwise the log during USB</span>
        <span class="c1"># disconnection will be lost.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">start_services</span><span class="p">(</span><span class="n">clear_log</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="c1"># Restore snippets.</span>
        <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">client</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snippet_clients</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">client</span><span class="o">.</span><span class="n">restore_app_connection</span><span class="p">()</span>
        <span class="c1"># Restore sl4a if needed.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sl4a</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sl4a</span><span class="o">.</span><span class="n">restore_app_connection</span><span class="p">()</span>
            <span class="c1"># Unpack the &#39;ed&#39; attribute for compatibility.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sl4a</span><span class="o">.</span><span class="n">ed</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">build_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the build info of this Android device, including build id and</span>
<span class="sd">        build type.</span>

<span class="sd">        This is not available if the device is in bootloader mode.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A dict with the build info of this Android device, or None if the</span>
<span class="sd">            device is in bootloader mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_bootloader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s1">&#39;Device is in fastboot mode, could not get build &#39;</span>
                           <span class="s1">&#39;info.&#39;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="n">info</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;build_id&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">getprop</span><span class="p">(</span><span class="s1">&#39;ro.build.id&#39;</span><span class="p">)</span>
        <span class="n">info</span><span class="p">[</span><span class="s1">&#39;build_type&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">getprop</span><span class="p">(</span><span class="s1">&#39;ro.build.type&#39;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">info</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_bootloader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if the device is in bootloader mode.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial</span> <span class="ow">in</span> <span class="n">list_fastboot_devices</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_adb_root</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;True if adb is running as root for this device.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="s1">&#39;0&#39;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span><span class="s1">&#39;id -u&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">adb</span><span class="o">.</span><span class="n">AdbError</span><span class="p">:</span>
            <span class="c1"># Wait a bit and retry to work around adb flakiness for this cmd.</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mf">0.2</span><span class="p">)</span>
            <span class="k">return</span> <span class="s1">&#39;0&#39;</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span><span class="s1">&#39;id -u&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">is_rootable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;If the build type is &#39;user&#39;, the device is not rootable.</span>

<span class="sd">        Other possible build types are &#39;userdebug&#39; and &#39;eng&#39;, both are rootable.</span>
<span class="sd">        We are checking the last four chars of the clean stdout because the</span>
<span class="sd">        stdout of the adb command could be polluted with other info like adb</span>
<span class="sd">        server startup message.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">build_type_output</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">getprop</span><span class="p">(</span><span class="s1">&#39;ro.build.type&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">build_type_output</span><span class="p">[</span><span class="o">-</span><span class="mi">4</span><span class="p">:]</span> <span class="o">!=</span> <span class="s1">&#39;user&#39;</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">model</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;The Android code name for the device.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If device is in bootloader mode, get mode name from fastboot.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_bootloader</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fastboot</span><span class="o">.</span><span class="n">getvar</span><span class="p">(</span><span class="s1">&#39;product&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="c1"># &#39;out&#39; is never empty because of the &#39;total time&#39; message fastboot</span>
            <span class="c1"># writes to stderr.</span>
            <span class="n">lines</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">lines</span><span class="p">:</span>
                <span class="n">tokens</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tokens</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">tokens</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="k">return</span> <span class="bp">None</span>
        <span class="n">model</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">getprop</span><span class="p">(</span><span class="s1">&#39;ro.build.product&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">model</span> <span class="o">==</span> <span class="s1">&#39;sprout&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">model</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">getprop</span><span class="p">(</span><span class="s1">&#39;ro.product.name&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

<div class="viewcode-block" id="AndroidDevice.load_config"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.load_config">[docs]</a>    <span class="k">def</span> <span class="nf">load_config</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">config</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add attributes to the AndroidDevice object based on config.</span>

<span class="sd">        Args:</span>
<span class="sd">            config: A dictionary representing the configs.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Error: The config is trying to overwrite</span>
<span class="sd">                an existing attribute.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">config</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DeviceError</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="p">(</span><span class="s1">&#39;Attribute </span><span class="si">%s</span><span class="s1"> already exists with value </span><span class="si">%s</span><span class="s1">, cannot set &#39;</span>
                     <span class="s1">&#39;again.&#39;</span><span class="p">)</span> <span class="o">%</span> <span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="nb">getattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">)))</span>
            <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">)</span></div>

<div class="viewcode-block" id="AndroidDevice.root_adb"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.root_adb">[docs]</a>    <span class="k">def</span> <span class="nf">root_adb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Change adb to root mode for this device if allowed.</span>

<span class="sd">        If executed on a production build, adb will not be switched to root</span>
<span class="sd">        mode per security restrictions.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">root</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">wait_for_device</span><span class="p">(</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">DEFAULT_TIMEOUT_BOOT_COMPLETION_SECOND</span><span class="p">)</span></div>

<div class="viewcode-block" id="AndroidDevice.load_snippet"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.load_snippet">[docs]</a>    <span class="k">def</span> <span class="nf">load_snippet</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">package</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts the snippet apk with the given package name and connects.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &gt;&gt;&gt; ad.load_snippet(</span>
<span class="sd">                    name=&#39;maps&#39;, package=&#39;com.google.maps.snippets&#39;)</span>
<span class="sd">            &gt;&gt;&gt; ad.maps.activateZoom(&#39;3&#39;)</span>

<span class="sd">        Args:</span>
<span class="sd">            name: The attribute name to which to attach the snippet server.</span>
<span class="sd">                e.g. name=&#39;maps&#39; will attach the snippet server to ad.maps.</span>
<span class="sd">            package: The package name defined in AndroidManifest.xml of the</span>
<span class="sd">                snippet apk.</span>

<span class="sd">        Raises:</span>
<span class="sd">            SnippetError: Illegal load operations are attempted.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Should not load snippet with the same attribute more than once.</span>
        <span class="k">if</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snippet_clients</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">SnippetError</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="s1">&#39;Attribute &quot;</span><span class="si">%s</span><span class="s1">&quot; is already registered with package &quot;</span><span class="si">%s</span><span class="s1">&quot;, it &#39;</span>
                <span class="s1">&#39;cannot be used again.&#39;</span> <span class="o">%</span>
                <span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snippet_clients</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">package</span><span class="p">))</span>
        <span class="c1"># Should not load snippet with an existing attribute.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
            <span class="k">raise</span> <span class="n">SnippetError</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="s1">&#39;Attribute &quot;</span><span class="si">%s</span><span class="s1">&quot; already exists, please use a different name.&#39;</span> <span class="o">%</span>
                <span class="n">name</span><span class="p">)</span>
        <span class="c1"># Should not load the same snippet package more than once.</span>
        <span class="k">for</span> <span class="n">client_name</span><span class="p">,</span> <span class="n">client</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snippet_clients</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">package</span> <span class="o">==</span> <span class="n">client</span><span class="o">.</span><span class="n">package</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">SnippetError</span><span class="p">(</span>
                    <span class="bp">self</span><span class="p">,</span>
                    <span class="s1">&#39;Snippet package &quot;</span><span class="si">%s</span><span class="s1">&quot; has already been loaded under name&#39;</span>
                    <span class="s1">&#39; &quot;</span><span class="si">%s</span><span class="s1">&quot;.&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">package</span><span class="p">,</span> <span class="n">client_name</span><span class="p">))</span>
        <span class="n">client</span> <span class="o">=</span> <span class="n">snippet_client</span><span class="o">.</span><span class="n">SnippetClient</span><span class="p">(</span>
            <span class="n">package</span><span class="o">=</span><span class="n">package</span><span class="p">,</span> <span class="n">adb_proxy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">client</span><span class="o">.</span><span class="n">start_app_and_connect</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># Log the stacktrace of `e` as re-raising doesn&#39;t preserve trace.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s1">&#39;Failed to start app and connect.&#39;</span><span class="p">)</span>
            <span class="c1"># If errors happen, make sure we clean up before raising.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">client</span><span class="o">.</span><span class="n">stop_app</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                    <span class="s1">&#39;Failed to stop app after failure to start app and connect.&#39;</span><span class="p">)</span>
            <span class="c1"># Raise the error from start app failure.</span>
            <span class="k">raise</span> <span class="n">e</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_snippet_clients</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">client</span>
        <span class="nb">setattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">client</span><span class="p">)</span></div>

<div class="viewcode-block" id="AndroidDevice.load_sl4a"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.load_sl4a">[docs]</a>    <span class="k">def</span> <span class="nf">load_sl4a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start sl4a service on the Android device.</span>

<span class="sd">        Launch sl4a server if not already running, spin up a session on the</span>
<span class="sd">        server, and two connections to this session.</span>

<span class="sd">        Creates an sl4a client (self.sl4a) with one connection, and one</span>
<span class="sd">        EventDispatcher obj (self.ed) with the other connection.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sl4a</span> <span class="o">=</span> <span class="n">sl4a_client</span><span class="o">.</span><span class="n">Sl4aClient</span><span class="p">(</span><span class="n">adb_proxy</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="p">,</span> <span class="n">log</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sl4a</span><span class="o">.</span><span class="n">start_app_and_connect</span><span class="p">()</span>
        <span class="c1"># Unpack the &#39;ed&#39; attribute for compatibility.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sl4a</span><span class="o">.</span><span class="n">ed</span></div>

    <span class="k">def</span> <span class="nf">_is_timestamp_in_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">begin_time</span><span class="p">,</span> <span class="n">end_time</span><span class="p">):</span>
        <span class="n">low</span> <span class="o">=</span> <span class="n">mobly_logger</span><span class="o">.</span><span class="n">logline_timestamp_comparator</span><span class="p">(</span><span class="n">begin_time</span><span class="p">,</span>
                                                        <span class="n">target</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="mi">0</span>
        <span class="n">high</span> <span class="o">=</span> <span class="n">mobly_logger</span><span class="o">.</span><span class="n">logline_timestamp_comparator</span><span class="p">(</span><span class="n">end_time</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="n">low</span> <span class="ow">and</span> <span class="n">high</span>

<div class="viewcode-block" id="AndroidDevice.cat_adb_log"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.cat_adb_log">[docs]</a>    <span class="k">def</span> <span class="nf">cat_adb_log</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">tag</span><span class="p">,</span> <span class="n">begin_time</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes an excerpt of the adb logcat log from a certain time point to</span>
<span class="sd">        current time.</span>

<span class="sd">        Args:</span>
<span class="sd">            tag: An identifier of the time period, usualy the name of a test.</span>
<span class="sd">            begin_time: Logline format timestamp of the beginning of the time</span>
<span class="sd">                period.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb_logcat_file_path</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DeviceError</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="s1">&#39;Attempting to cat adb log when none has been collected.&#39;</span><span class="p">)</span>
        <span class="n">end_time</span> <span class="o">=</span> <span class="n">mobly_logger</span><span class="o">.</span><span class="n">get_log_line_timestamp</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Extracting adb log from logcat.&#39;</span><span class="p">)</span>
        <span class="n">adb_excerpt_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="p">,</span> <span class="s1">&#39;AdbLogExcerpts&#39;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">adb_excerpt_path</span><span class="p">)</span>
        <span class="n">f_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">adb_logcat_file_path</span><span class="p">)</span>
        <span class="n">out_name</span> <span class="o">=</span> <span class="n">f_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;adblog,&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
        <span class="n">out_name</span> <span class="o">=</span> <span class="s1">&#39;,</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">begin_time</span><span class="p">,</span> <span class="n">out_name</span><span class="p">)</span>
        <span class="n">tag_len</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">MAX_FILENAME_LEN</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">out_name</span><span class="p">)</span>
        <span class="n">tag</span> <span class="o">=</span> <span class="n">tag</span><span class="p">[:</span><span class="n">tag_len</span><span class="p">]</span>
        <span class="n">out_name</span> <span class="o">=</span> <span class="n">tag</span> <span class="o">+</span> <span class="n">out_name</span>
        <span class="n">full_adblog_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">adb_excerpt_path</span><span class="p">,</span> <span class="n">out_name</span><span class="p">)</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">full_adblog_path</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">out</span><span class="p">:</span>
            <span class="n">in_file</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb_logcat_file_path</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">in_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;utf-8&#39;</span><span class="p">,</span> <span class="n">errors</span><span class="o">=</span><span class="s1">&#39;replace&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">in_range</span> <span class="o">=</span> <span class="bp">False</span>
                <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">=</span> <span class="bp">None</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">line</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">readline</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">continue</span>
                    <span class="n">line_time</span> <span class="o">=</span> <span class="n">line</span><span class="p">[:</span><span class="n">mobly_logger</span><span class="o">.</span><span class="n">log_line_timestamp_len</span><span class="p">]</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">mobly_logger</span><span class="o">.</span><span class="n">is_valid_logline_timestamp</span><span class="p">(</span><span class="n">line_time</span><span class="p">):</span>
                        <span class="k">continue</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_timestamp_in_range</span><span class="p">(</span><span class="n">line_time</span><span class="p">,</span> <span class="n">begin_time</span><span class="p">,</span>
                                                   <span class="n">end_time</span><span class="p">):</span>
                        <span class="n">in_range</span> <span class="o">=</span> <span class="bp">True</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">):</span>
                            <span class="n">line</span> <span class="o">+=</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span>
                        <span class="n">out</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">in_range</span><span class="p">:</span>
                            <span class="k">break</span></div>

<div class="viewcode-block" id="AndroidDevice.start_adb_logcat"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.start_adb_logcat">[docs]</a>    <span class="k">def</span> <span class="nf">start_adb_logcat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">clear_log</span><span class="o">=</span><span class="bp">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts a standing adb logcat collection in separate subprocesses and</span>
<span class="sd">        save the logcat in a file.</span>

<span class="sd">        This clears the previous cached logcat content on device.</span>

<span class="sd">        Args:</span>
<span class="sd">            clear: If True, clear device log before starting logcat.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adb_logcat_process</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DeviceError</span><span class="p">(</span>
                <span class="bp">self</span><span class="p">,</span>
                <span class="s1">&#39;Logcat thread is already running, cannot start another one.&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">clear_log</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_clear_adb_log</span><span class="p">()</span>
        <span class="c1"># Disable adb log spam filter for rootable devices. Have to stop and</span>
        <span class="c1"># clear settings first because &#39;start&#39; doesn&#39;t support --clear option</span>
        <span class="c1"># before Android N.</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_rootable</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span><span class="s1">&#39;logpersist.stop --clear&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span><span class="s1">&#39;logpersist.start&#39;</span><span class="p">)</span>
        <span class="n">f_name</span> <span class="o">=</span> <span class="s1">&#39;adblog,</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="p">)</span>
        <span class="n">logcat_file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="p">,</span> <span class="n">f_name</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">extra_params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb_logcat_param</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="n">extra_params</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="n">cmd</span> <span class="o">=</span> <span class="s1">&#39;&quot;</span><span class="si">%s</span><span class="s1">&quot; -s </span><span class="si">%s</span><span class="s1"> logcat -v threadtime </span><span class="si">%s</span><span class="s1"> &gt;&gt; &quot;</span><span class="si">%s</span><span class="s1">&quot;&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">adb</span><span class="o">.</span><span class="n">ADB</span><span class="p">,</span>
                                                              <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="p">,</span>
                                                              <span class="n">extra_params</span><span class="p">,</span>
                                                              <span class="n">logcat_file_path</span><span class="p">)</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">start_standing_subprocess</span><span class="p">(</span><span class="n">cmd</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_adb_logcat_process</span> <span class="o">=</span> <span class="n">process</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adb_logcat_file_path</span> <span class="o">=</span> <span class="n">logcat_file_path</span></div>

<div class="viewcode-block" id="AndroidDevice.stop_adb_logcat"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.stop_adb_logcat">[docs]</a>    <span class="k">def</span> <span class="nf">stop_adb_logcat</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Stops the adb logcat collection subprocess.</span>

<span class="sd">        Raises:</span>
<span class="sd">            DeviceError: raised if there&#39;s no adb logcat collection going on.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_adb_logcat_process</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">DeviceError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;No ongoing adb logcat collection found.&#39;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">stop_standing_subprocess</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_adb_logcat_process</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_adb_logcat_process</span> <span class="o">=</span> <span class="bp">None</span></div>

<div class="viewcode-block" id="AndroidDevice.take_bug_report"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.take_bug_report">[docs]</a>    <span class="k">def</span> <span class="nf">take_bug_report</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">test_name</span><span class="p">,</span> <span class="n">begin_time</span><span class="p">,</span> <span class="n">timetout</span><span class="o">=</span><span class="mi">300</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Takes a bug report on the device and stores it in a file.</span>

<span class="sd">        Args:</span>
<span class="sd">            test_name: Name of the test method that triggered this bug report.</span>
<span class="sd">            begin_time: Timestamp of when the test started.</span>
<span class="sd">            timeout: float, the number of seconds to wait for bugreport to</span>
<span class="sd">                complete, default is 5min.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">new_br</span> <span class="o">=</span> <span class="bp">True</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">stdout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span><span class="s1">&#39;bugreportz -v&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="c1"># This check is necessary for builds before N, where adb shell&#39;s ret</span>
            <span class="c1"># code and stderr are not propagated properly.</span>
            <span class="k">if</span> <span class="s1">&#39;not found&#39;</span> <span class="ow">in</span> <span class="n">stdout</span><span class="p">:</span>
                <span class="n">new_br</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="k">except</span> <span class="n">adb</span><span class="o">.</span><span class="n">AdbError</span><span class="p">:</span>
            <span class="n">new_br</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="n">br_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">log_path</span><span class="p">,</span> <span class="s1">&#39;BugReports&#39;</span><span class="p">)</span>
        <span class="n">utils</span><span class="o">.</span><span class="n">create_dir</span><span class="p">(</span><span class="n">br_path</span><span class="p">)</span>
        <span class="n">base_name</span> <span class="o">=</span> <span class="s1">&#39;,</span><span class="si">%s</span><span class="s1">,</span><span class="si">%s</span><span class="s1">.txt&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">begin_time</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_br</span><span class="p">:</span>
            <span class="n">base_name</span> <span class="o">=</span> <span class="n">base_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;.zip&#39;</span><span class="p">)</span>
        <span class="n">test_name_len</span> <span class="o">=</span> <span class="n">utils</span><span class="o">.</span><span class="n">MAX_FILENAME_LEN</span> <span class="o">-</span> <span class="nb">len</span><span class="p">(</span><span class="n">base_name</span><span class="p">)</span>
        <span class="n">out_name</span> <span class="o">=</span> <span class="n">test_name</span><span class="p">[:</span><span class="n">test_name_len</span><span class="p">]</span> <span class="o">+</span> <span class="n">base_name</span>
        <span class="n">full_out_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">br_path</span><span class="p">,</span> <span class="n">out_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">,</span> <span class="s1">r&#39;\ &#39;</span><span class="p">))</span>
        <span class="c1"># in case device restarted, wait for adb interface to return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">wait_for_boot_completion</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Taking bugreport for </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">test_name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">new_br</span><span class="p">:</span>
            <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span>
                <span class="s1">&#39;bugreportz&#39;</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timetout</span><span class="p">)</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s1">&#39;utf-8&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">out</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;OK&#39;</span><span class="p">):</span>
                <span class="k">raise</span> <span class="n">DeviceError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Failed to take bugreport: </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">out</span><span class="p">)</span>
            <span class="n">br_out_path</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;:&#39;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">pull</span><span class="p">([</span><span class="n">br_out_path</span><span class="p">,</span> <span class="n">full_out_path</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># shell=True as this command redirects the stdout to a local file</span>
            <span class="c1"># using shell redirection.</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">bugreport</span><span class="p">(</span>
                <span class="s1">&#39; &gt; </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">full_out_path</span><span class="p">,</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timetout</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Bugreport for </span><span class="si">%s</span><span class="s1"> taken at </span><span class="si">%s</span><span class="s1">.&#39;</span><span class="p">,</span> <span class="n">test_name</span><span class="p">,</span>
                      <span class="n">full_out_path</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_clear_adb_log</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Clears cached adb content.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">logcat</span><span class="p">(</span><span class="s1">&#39;-c&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">_terminate_sl4a</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Terminate the current sl4a session.</span>

<span class="sd">        Send terminate signal to sl4a server; stop dispatcher associated with</span>
<span class="sd">        the session. Clear corresponding droids and dispatchers from cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sl4a</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sl4a</span><span class="o">.</span><span class="n">stop_app</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">sl4a</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ed</span> <span class="o">=</span> <span class="bp">None</span>

<div class="viewcode-block" id="AndroidDevice.run_iperf_client"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.run_iperf_client">[docs]</a>    <span class="k">def</span> <span class="nf">run_iperf_client</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">server_host</span><span class="p">,</span> <span class="n">extra_args</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Start iperf client on the device.</span>

<span class="sd">        Return status as true if iperf client start successfully.</span>
<span class="sd">        And data flow information as results.</span>

<span class="sd">        Args:</span>
<span class="sd">            server_host: Address of the iperf server.</span>
<span class="sd">            extra_args: A string representing extra arguments for iperf client,</span>
<span class="sd">                e.g. &#39;-i 1 -t 30&#39;.</span>

<span class="sd">        Returns:</span>
<span class="sd">            status: true if iperf client start successfully.</span>
<span class="sd">            results: results have data flow information</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">shell</span><span class="p">(</span><span class="s1">&#39;iperf3 -c </span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">server_host</span><span class="p">,</span> <span class="n">extra_args</span><span class="p">))</span>
        <span class="n">clean_out</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="s1">&#39;utf-8&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;error&#39;</span> <span class="ow">in</span> <span class="n">clean_out</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
            <span class="k">return</span> <span class="bp">False</span><span class="p">,</span> <span class="n">clean_out</span>
        <span class="k">return</span> <span class="bp">True</span><span class="p">,</span> <span class="n">clean_out</span></div>

<div class="viewcode-block" id="AndroidDevice.wait_for_boot_completion"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.wait_for_boot_completion">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_boot_completion</span><span class="p">(</span>
            <span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">DEFAULT_TIMEOUT_BOOT_COMPLETION_SECOND</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Waits for Android framework to broadcast ACTION_BOOT_COMPLETED.</span>

<span class="sd">        This function times out after 15 minutes.</span>

<span class="sd">        Args:</span>
<span class="sd">            timeout: float, the number of seconds to wait before timing out.</span>
<span class="sd">                If not specified, no timeout takes effect.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">timeout_start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">wait_for_device</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">)</span>
        <span class="k">while</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">timeout_start</span> <span class="o">+</span> <span class="n">timeout</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_boot_completed</span><span class="p">():</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="n">adb</span><span class="o">.</span><span class="n">AdbError</span><span class="p">:</span>
                <span class="c1"># adb shell calls may fail during certain period of booting</span>
                <span class="c1"># process, which is normal. Ignoring these errors.</span>
                <span class="k">pass</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
        <span class="k">raise</span> <span class="n">DeviceError</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s1">&#39;Booting process timed out&#39;</span><span class="p">)</span></div>

<div class="viewcode-block" id="AndroidDevice.is_boot_completed"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.is_boot_completed">[docs]</a>    <span class="k">def</span> <span class="nf">is_boot_completed</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if device boot is completed by verifying system property.&quot;&quot;&quot;</span>
        <span class="n">completed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">getprop</span><span class="p">(</span><span class="s1">&#39;sys.boot_completed&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">completed</span> <span class="o">==</span> <span class="s1">&#39;1&#39;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Device boot completed.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span></div>

<div class="viewcode-block" id="AndroidDevice.is_adb_detectable"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.is_adb_detectable">[docs]</a>    <span class="k">def</span> <span class="nf">is_adb_detectable</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Checks if USB is on and device is ready by verifying adb devices.&quot;&quot;&quot;</span>
        <span class="n">serials</span> <span class="o">=</span> <span class="n">list_adb_devices</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">serial</span> <span class="ow">in</span> <span class="n">serials</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">log</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Is now adb detectable.&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">True</span>
        <span class="k">return</span> <span class="bp">False</span></div>

    <span class="k">def</span> <span class="nf">_get_active_snippet_info</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Collects information on currently active snippet clients.</span>
<span class="sd">        The info is used for restoring the snippet clients after rebooting the</span>
<span class="sd">        device.</span>
<span class="sd">        Returns:</span>
<span class="sd">            A list of tuples, each tuple&#39;s first element is the name of the</span>
<span class="sd">            snippet client&#39;s attribute, the second element is the package name</span>
<span class="sd">            of the snippet.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">snippet_info</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">attr_name</span><span class="p">,</span> <span class="n">client</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_snippet_clients</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">snippet_info</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">attr_name</span><span class="p">,</span> <span class="n">client</span><span class="o">.</span><span class="n">package</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">snippet_info</span>

<div class="viewcode-block" id="AndroidDevice.reboot"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDevice.reboot">[docs]</a>    <span class="k">def</span> <span class="nf">reboot</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reboots the device.</span>

<span class="sd">        Terminate all sl4a sessions, reboot the device, wait for device to</span>
<span class="sd">        complete booting, and restart an sl4a session.</span>

<span class="sd">        This is a blocking method.</span>

<span class="sd">        This is probably going to print some error messages in console. Only</span>
<span class="sd">        use if there&#39;s no other option.</span>

<span class="sd">        Raises:</span>
<span class="sd">            Error: Waiting for completion timed out.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_bootloader</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">fastboot</span><span class="o">.</span><span class="n">reboot</span><span class="p">()</span>
            <span class="k">return</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_reboot</span><span class="p">():</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">adb</span><span class="o">.</span><span class="n">reboot</span><span class="p">()</span></div></div>


<div class="viewcode-block" id="AndroidDeviceLoggerAdapter"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDeviceLoggerAdapter">[docs]</a><span class="k">class</span> <span class="nc">AndroidDeviceLoggerAdapter</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">LoggerAdapter</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A wrapper class that adds a prefix to each log line.</span>

<span class="sd">    Usage:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        my_log = AndroidDeviceLoggerAdapter(logging.getLogger(), {</span>
<span class="sd">            &#39;tag&#39;: &lt;custom tag&gt;</span>
<span class="sd">        })</span>

<span class="sd">    Then each log line added by my_log will have a prefix</span>
<span class="sd">    &#39;[AndroidDevice|&lt;tag&gt;]&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="AndroidDeviceLoggerAdapter.process"><a class="viewcode-back" href="../../../mobly.controllers.html#mobly.controllers.android_device.AndroidDeviceLoggerAdapter.process">[docs]</a>    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">):</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="n">_DEBUG_PREFIX_TEMPLATE</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">extra</span><span class="p">[</span><span class="s1">&#39;tag&#39;</span><span class="p">],</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">)</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;Copyright 2016 Google Inc..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>