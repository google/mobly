<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">


<html xmlns="http://www.w3.org/1999/xhtml">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    
    <title>mobly.controllers.android_device_lib.event_dispatcher &mdash; Mobly  documentation</title>
    
    <link rel="stylesheet" href="../../../../_static/alabaster.css" type="text/css" />
    <link rel="stylesheet" href="../../../../_static/pygments.css" type="text/css" />
    
    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
        URL_ROOT:    '../../../../',
        VERSION:     '',
        COLLAPSE_INDEX: false,
        FILE_SUFFIX: '.html',
        HAS_SOURCE:  true
      };
    </script>
    <script type="text/javascript" src="../../../../_static/jquery.js"></script>
    <script type="text/javascript" src="../../../../_static/underscore.js"></script>
    <script type="text/javascript" src="../../../../_static/doctools.js"></script>
    <link rel="top" title="Mobly  documentation" href="../../../../index.html" />
    <link rel="up" title="Module code" href="../../../index.html" />
   
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head>
  <body role="document">  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for mobly.controllers.android_device_lib.event_dispatcher</h1><div class="highlight"><pre>
<span class="c1"># Copyright 2016 Google Inc.</span>
<span class="c1"># </span>
<span class="c1"># Licensed under the Apache License, Version 2.0 (the &quot;License&quot;);</span>
<span class="c1"># you may not use this file except in compliance with the License.</span>
<span class="c1"># You may obtain a copy of the License at</span>
<span class="c1"># </span>
<span class="c1">#     http://www.apache.org/licenses/LICENSE-2.0</span>
<span class="c1"># </span>
<span class="c1"># Unless required by applicable law or agreed to in writing, software</span>
<span class="c1"># distributed under the License is distributed on an &quot;AS IS&quot; BASIS,</span>
<span class="c1"># WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.</span>
<span class="c1"># See the License for the specific language governing permissions and</span>
<span class="c1"># limitations under the License.</span>

<span class="kn">from</span> <span class="nn">concurrent.futures</span> <span class="kn">import</span> <span class="n">ThreadPoolExecutor</span>
<span class="kn">import</span> <span class="nn">queue</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">traceback</span>


<div class="viewcode-block" id="EventDispatcherError"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.EventDispatcherError">[docs]</a><span class="k">class</span> <span class="nc">EventDispatcherError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">pass</span></div>


<div class="viewcode-block" id="IllegalStateError"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.IllegalStateError">[docs]</a><span class="k">class</span> <span class="nc">IllegalStateError</span><span class="p">(</span><span class="n">EventDispatcherError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raise when user tries to put event_dispatcher into an illegal state.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="DuplicateError"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.DuplicateError">[docs]</a><span class="k">class</span> <span class="nc">DuplicateError</span><span class="p">(</span><span class="n">EventDispatcherError</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Raise when a duplicate is being created and it shouldn&#39;t.</span>
<span class="sd">    &quot;&quot;&quot;</span></div>


<div class="viewcode-block" id="EventDispatcher"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.EventDispatcher">[docs]</a><span class="k">class</span> <span class="nc">EventDispatcher</span><span class="p">:</span>
    <span class="sd">&quot;&quot;&quot;Class managing events for an sl4a connection.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">DEFAULT_TIMEOUT</span> <span class="o">=</span> <span class="mi">60</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">sl4a</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sl4a</span> <span class="o">=</span> <span class="n">sl4a</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poller</span> <span class="o">=</span> <span class="bp">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">RLock</span><span class="p">()</span>

<div class="viewcode-block" id="EventDispatcher.poll_events"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.EventDispatcher.poll_events">[docs]</a>    <span class="k">def</span> <span class="nf">poll_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Continuously polls all types of events from sl4a.</span>

<span class="sd">        Events are sorted by name and store in separate queues.</span>
<span class="sd">        If there are registered handlers, the handlers will be called with</span>
<span class="sd">        corresponding event immediately upon event discovery, and the event</span>
<span class="sd">        won&#39;t be stored. If exceptions occur, stop the dispatcher and return</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">while</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="n">event_obj</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="n">event_name</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">event_obj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sl4a</span><span class="o">.</span><span class="n">eventWait</span><span class="p">(</span><span class="mi">50000</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
                    <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Exception happened during polling.&quot;</span><span class="p">)</span>
                    <span class="k">print</span><span class="p">(</span><span class="n">traceback</span><span class="o">.</span><span class="n">format_exc</span><span class="p">())</span>
                    <span class="k">raise</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">event_obj</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">elif</span> <span class="s1">&#39;name&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">event_obj</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s2">&quot;Received Malformed event {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">event_obj</span><span class="p">))</span>
                <span class="k">continue</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">event_name</span> <span class="o">=</span> <span class="n">event_obj</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span>
            <span class="c1"># if handler registered, process event</span>
            <span class="k">if</span> <span class="n">event_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handle_subscribed_event</span><span class="p">(</span><span class="n">event_obj</span><span class="p">,</span> <span class="n">event_name</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">event_name</span> <span class="o">==</span> <span class="s2">&quot;EventDispatcherShutdown&quot;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_sl4a</span><span class="o">.</span><span class="n">closeSl4aSession</span><span class="p">()</span>
                <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">event_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">:</span>  <span class="c1"># otherwise, cache event</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event_obj</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">q</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
                    <span class="n">q</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">event_obj</span><span class="p">)</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">q</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="EventDispatcher.register_handler"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.EventDispatcher.register_handler">[docs]</a>    <span class="k">def</span> <span class="nf">register_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">handler</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Registers an event handler.</span>

<span class="sd">        One type of event can only have one event handler associated with it.</span>

<span class="sd">        Args:</span>
<span class="sd">            handler: The event handler function to be registered.</span>
<span class="sd">            event_name: Name of the event the handler is for.</span>
<span class="sd">            args: User arguments to be passed to the handler when it&#39;s called.</span>

<span class="sd">        Raises:</span>
<span class="sd">            IllegalStateError: Raised if attempts to register a handler after</span>
<span class="sd">                the dispatcher starts running.</span>
<span class="sd">            DuplicateError: Raised if attempts to register more than one</span>
<span class="sd">                handler for one type of event.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IllegalStateError</span><span class="p">((</span><span class="s2">&quot;Can&#39;t register service after polling is&quot;</span>
                                     <span class="s2">&quot; started&quot;</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">event_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">DuplicateError</span><span class="p">(</span><span class="s1">&#39;A handler for {} already exists&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">event_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="EventDispatcher.start"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.EventDispatcher.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Starts the event dispatcher.</span>

<span class="sd">        Initiates executor and start polling events.</span>

<span class="sd">        Raises:</span>
<span class="sd">            IllegalStateError: Can&#39;t start a dispatcher again when it&#39;s already</span>
<span class="sd">                running.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="bp">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">executor</span> <span class="o">=</span> <span class="n">ThreadPoolExecutor</span><span class="p">(</span><span class="n">max_workers</span><span class="o">=</span><span class="mi">32</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">poller</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">poll_events</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IllegalStateError</span><span class="p">(</span><span class="s2">&quot;Dispatcher is already started.&quot;</span><span class="p">)</span></div>

<div class="viewcode-block" id="EventDispatcher.clean_up"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.EventDispatcher.clean_up">[docs]</a>    <span class="k">def</span> <span class="nf">clean_up</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clean up and release resources after the event dispatcher polling</span>
<span class="sd">        loop has been broken.</span>

<span class="sd">        The following things happen:</span>
<span class="sd">        1. Clear all events and flags.</span>
<span class="sd">        2. Close the sl4a client the event_dispatcher object holds.</span>
<span class="sd">        3. Shut down executor without waiting.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">started</span> <span class="o">=</span> <span class="bp">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">clear_all_events</span><span class="p">()</span>
        <span class="c1"># At this point, the sl4a apk is destroyed and nothing is listening on</span>
        <span class="c1"># the socket. Avoid sending any sl4a commands; just clean up the socket</span>
        <span class="c1"># and return.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_sl4a</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">poller</span><span class="o">.</span><span class="n">set_result</span><span class="p">(</span><span class="s2">&quot;Done&quot;</span><span class="p">)</span>
        <span class="c1"># The polling thread is guaranteed to finish after a max of 60 seconds,</span>
        <span class="c1"># so we don&#39;t wait here.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">shutdown</span><span class="p">(</span><span class="n">wait</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span></div>

<div class="viewcode-block" id="EventDispatcher.pop_event"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.EventDispatcher.pop_event">[docs]</a>    <span class="k">def</span> <span class="nf">pop_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">DEFAULT_TIMEOUT</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pop an event from its queue.</span>

<span class="sd">        Return and remove the oldest entry of an event.</span>
<span class="sd">        Block until an event of specified name is available or</span>
<span class="sd">        times out if timeout is set.</span>

<span class="sd">        Args:</span>
<span class="sd">            event_name: Name of the event to be popped.</span>
<span class="sd">            timeout: Number of seconds to wait when event is not present.</span>
<span class="sd">                Never times out if None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            The oldest entry of the specified event. None if timed out.</span>

<span class="sd">        Raises:</span>
<span class="sd">            IllegalStateError: Raised if pop is called before the dispatcher</span>
<span class="sd">                starts polling.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IllegalStateError</span><span class="p">(</span>
                <span class="s2">&quot;Dispatcher needs to be started before popping.&quot;</span><span class="p">)</span>

        <span class="n">e_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_event_q</span><span class="p">(</span><span class="n">event_name</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">e_queue</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Failed to get an event queue for {}&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">event_name</span><span class="p">))</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># Block for timeout</span>
            <span class="k">if</span> <span class="n">timeout</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">e_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">True</span><span class="p">,</span> <span class="n">timeout</span><span class="p">)</span>
            <span class="c1"># Non-blocking poll for event</span>
            <span class="k">elif</span> <span class="n">timeout</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">e_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">False</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Block forever on event wait</span>
                <span class="k">return</span> <span class="n">e_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">True</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">(</span><span class="s1">&#39;Timeout after {}s waiting for event: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">timeout</span><span class="p">,</span> <span class="n">event_name</span><span class="p">))</span></div>

<div class="viewcode-block" id="EventDispatcher.wait_for_event"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.EventDispatcher.wait_for_event">[docs]</a>    <span class="k">def</span> <span class="nf">wait_for_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                       <span class="n">event_name</span><span class="p">,</span>
                       <span class="n">predicate</span><span class="p">,</span>
                       <span class="n">timeout</span><span class="o">=</span><span class="n">DEFAULT_TIMEOUT</span><span class="p">,</span>
                       <span class="o">*</span><span class="n">args</span><span class="p">,</span>
                       <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Wait for an event that satisfies a predicate to appear.</span>

<span class="sd">        Continuously pop events of a particular name and check against the</span>
<span class="sd">        predicate until an event that satisfies the predicate is popped or</span>
<span class="sd">        timed out. Note this will remove all the events of the same name that</span>
<span class="sd">        do not satisfy the predicate in the process.</span>

<span class="sd">        Args:</span>
<span class="sd">            event_name: Name of the event to be popped.</span>
<span class="sd">            predicate: A function that takes an event and returns True if the</span>
<span class="sd">                predicate is satisfied, False otherwise.</span>
<span class="sd">            timeout: Number of seconds to wait.</span>
<span class="sd">            *args: Optional positional args passed to predicate().</span>
<span class="sd">            **kwargs: Optional keyword args passed to predicate().</span>

<span class="sd">        Returns:</span>
<span class="sd">            The event that satisfies the predicate.</span>

<span class="sd">        Raises:</span>
<span class="sd">            queue.Empty: Raised if no event that satisfies the predicate was</span>
<span class="sd">                found before time out.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>

        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="n">event</span> <span class="o">=</span> <span class="bp">None</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_event</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="n">event</span> <span class="ow">and</span> <span class="n">predicate</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">event</span>

            <span class="k">if</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">deadline</span><span class="p">:</span>
                <span class="k">raise</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">(</span>
                    <span class="s1">&#39;Timeout after {}s waiting for event: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                        <span class="n">timeout</span><span class="p">,</span> <span class="n">event_name</span><span class="p">))</span></div>

<div class="viewcode-block" id="EventDispatcher.pop_events"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.EventDispatcher.pop_events">[docs]</a>    <span class="k">def</span> <span class="nf">pop_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regex_pattern</span><span class="p">,</span> <span class="n">timeout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pop events whose names match a regex pattern.</span>

<span class="sd">        If such event(s) exist, pop one event from each event queue that</span>
<span class="sd">        satisfies the condition. Otherwise, wait for an event that satisfies</span>
<span class="sd">        the condition to occur, with timeout.</span>

<span class="sd">        Results are sorted by timestamp in ascending order.</span>

<span class="sd">        Args:</span>
<span class="sd">            regex_pattern: The regular expression pattern that an event name</span>
<span class="sd">                should match in order to be popped.</span>
<span class="sd">            timeout: Number of seconds to wait for events in case no event</span>
<span class="sd">                matching the condition exits when the function is called.</span>

<span class="sd">        Returns:</span>
<span class="sd">            Pop events whose names match a regex pattern.</span>
<span class="sd">            Empty if none exist and the wait timed out.</span>

<span class="sd">        Raises:</span>
<span class="sd">            IllegalStateError: Raised if pop is called before the dispatcher</span>
<span class="sd">                starts polling.</span>
<span class="sd">            queue.Empty: Raised if no event was found before time out.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IllegalStateError</span><span class="p">(</span>
                <span class="s2">&quot;Dispatcher needs to be started before popping.&quot;</span><span class="p">)</span>
        <span class="n">deadline</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">+</span> <span class="n">timeout</span>
        <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
            <span class="c1">#TODO: fix the sleep loop</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_match_and_pop</span><span class="p">(</span><span class="n">regex_pattern</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">deadline</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">(</span><span class="s1">&#39;Timeout after {}s waiting for event: {}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="n">timeout</span><span class="p">,</span> <span class="n">regex_pattern</span><span class="p">))</span>

        <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">results</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">event</span><span class="p">:</span> <span class="n">event</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_match_and_pop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regex_pattern</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pop one event from each of the event queues whose names</span>
<span class="sd">        match (in a sense of regular expression) regex_pattern.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="n">regex_pattern</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
                <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">name</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">q</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">q</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="bp">False</span><span class="p">))</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">results</span>

<div class="viewcode-block" id="EventDispatcher.get_event_q"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.EventDispatcher.get_event_q">[docs]</a>    <span class="k">def</span> <span class="nf">get_event_q</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Obtain the queue storing events of the specified name.</span>

<span class="sd">        If no event of this name has been polled, wait for one to.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A queue storing all the events of the specified name.</span>
<span class="sd">            None if timed out.</span>
<span class="sd">            Number of seconds to wait for the operation.</span>

<span class="sd">        Raises:</span>
<span class="sd">            queue.Empty: Raised if the queue does not exist and timeout has</span>
<span class="sd">                passed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">event_name</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span>
                <span class="n">event_name</span><span class="p">]</span> <span class="ow">is</span> <span class="bp">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">queue</span><span class="o">.</span><span class="n">Queue</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

        <span class="n">event_queue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">event_queue</span></div>

<div class="viewcode-block" id="EventDispatcher.handle_subscribed_event"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.EventDispatcher.handle_subscribed_event">[docs]</a>    <span class="k">def</span> <span class="nf">handle_subscribed_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">,</span> <span class="n">event_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Execute the registered handler of an event.</span>

<span class="sd">        Retrieve the handler and its arguments, and execute the handler in a</span>
<span class="sd">            new thread.</span>

<span class="sd">        Args:</span>
<span class="sd">            event_obj: Json object of the event.</span>
<span class="sd">            event_name: Name of the event to call handler for.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">handler</span><span class="p">,</span> <span class="n">args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="n">handler</span><span class="p">,</span> <span class="n">event_obj</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_handler</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span> <span class="n">user_args</span><span class="p">,</span> <span class="n">event_timeout</span><span class="p">,</span>
                <span class="n">cond</span><span class="p">,</span> <span class="n">cond_timeout</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pop an event of specified type and calls its handler on it. If</span>
<span class="sd">        condition is not None, block until condition is met or timeout.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">cond</span><span class="p">:</span>
            <span class="n">cond</span><span class="o">.</span><span class="n">wait</span><span class="p">(</span><span class="n">cond_timeout</span><span class="p">)</span>
        <span class="n">event</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pop_event</span><span class="p">(</span><span class="n">event_name</span><span class="p">,</span> <span class="n">event_timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">event_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="o">*</span><span class="n">user_args</span><span class="p">)</span>

<div class="viewcode-block" id="EventDispatcher.handle_event"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.EventDispatcher.handle_event">[docs]</a>    <span class="k">def</span> <span class="nf">handle_event</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                     <span class="n">event_handler</span><span class="p">,</span>
                     <span class="n">event_name</span><span class="p">,</span>
                     <span class="n">user_args</span><span class="p">,</span>
                     <span class="n">event_timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">cond</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span>
                     <span class="n">cond_timeout</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Handle events that don&#39;t have registered handlers</span>

<span class="sd">        In a new thread, poll one event of specified type from its queue and</span>
<span class="sd">        execute its handler. If no such event exists, the thread waits until</span>
<span class="sd">        one appears.</span>

<span class="sd">        Args:</span>
<span class="sd">            event_handler: Handler for the event, which should take at least</span>
<span class="sd">                one argument - the event json object.</span>
<span class="sd">            event_name: Name of the event to be handled.</span>
<span class="sd">            user_args: User arguments for the handler; to be passed in after</span>
<span class="sd">                the event json.</span>
<span class="sd">            event_timeout: Number of seconds to wait for the event to come.</span>
<span class="sd">            cond: A condition to wait on before executing the handler. Should</span>
<span class="sd">                be a threading.Event object.</span>
<span class="sd">            cond_timeout: Number of seconds to wait before the condition times</span>
<span class="sd">                out. Never times out if None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A concurrent.Future object associated with the handler.</span>
<span class="sd">            If blocking call worker.result() is triggered, the handler</span>
<span class="sd">            needs to return something to unblock.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">worker</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">executor</span><span class="o">.</span><span class="n">submit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_handle</span><span class="p">,</span> <span class="n">event_handler</span><span class="p">,</span> <span class="n">event_name</span><span class="p">,</span>
                                      <span class="n">user_args</span><span class="p">,</span> <span class="n">event_timeout</span><span class="p">,</span> <span class="n">cond</span><span class="p">,</span>
                                      <span class="n">cond_timeout</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">worker</span></div>

<div class="viewcode-block" id="EventDispatcher.pop_all"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.EventDispatcher.pop_all">[docs]</a>    <span class="k">def</span> <span class="nf">pop_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return and remove all stored events of a specified name.</span>

<span class="sd">        Pops all events from their queue. May miss the latest ones.</span>
<span class="sd">        If no event is available, return immediately.</span>

<span class="sd">        Args:</span>
<span class="sd">            event_name: Name of the events to be popped.</span>

<span class="sd">        Returns:</span>
<span class="sd">           List of the desired events.</span>

<span class="sd">        Raises:</span>
<span class="sd">            IllegalStateError: Raised if pop is called before the dispatcher</span>
<span class="sd">                starts polling.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">started</span><span class="p">:</span>
            <span class="k">raise</span> <span class="n">IllegalStateError</span><span class="p">((</span><span class="s2">&quot;Dispatcher needs to be started before &quot;</span>
                                     <span class="s2">&quot;popping.&quot;</span><span class="p">))</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
            <span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
                <span class="n">e</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="p">[</span><span class="n">event_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
                <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">,</span> <span class="ne">KeyError</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">results</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="EventDispatcher.clear_events"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.EventDispatcher.clear_events">[docs]</a>    <span class="k">def</span> <span class="nf">clear_events</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">event_name</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear all events of a particular name.</span>

<span class="sd">        Args:</span>
<span class="sd">            event_name: Name of the events to be popped.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_event_q</span><span class="p">(</span><span class="n">event_name</span><span class="p">)</span>
            <span class="n">q</span><span class="o">.</span><span class="n">queue</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">queue</span><span class="o">.</span><span class="n">Empty</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div>

<div class="viewcode-block" id="EventDispatcher.clear_all_events"><a class="viewcode-back" href="../../../../mobly.controllers.android_device_lib.html#mobly.controllers.android_device_lib.event_dispatcher.EventDispatcher.clear_all_events">[docs]</a>    <span class="k">def</span> <span class="nf">clear_all_events</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Clear all event queues and their cached events.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">event_dict</span><span class="o">.</span><span class="n">clear</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span></div></div>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper"><div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../../index.html">Documentation overview</a><ul>
  <li><a href="../../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3>Quick search</h3>
    <form class="search" action="../../../../search.html" method="get">
      <input type="text" name="q" />
      <input type="submit" value="Go" />
      <input type="hidden" name="check_keywords" value="yes" />
      <input type="hidden" name="area" value="default" />
    </form>
    <p class="searchtip" style="font-size: 90%">
    Enter search terms or a module, class or function name.
    </p>
</div>
<script type="text/javascript">$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;Copyright 2016 Google Inc..
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 1.3.6</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.7</a>
      
    </div>

    

    
  </body>
</html>